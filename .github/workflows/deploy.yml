name: Deploy SageMaker Endpoint
on: { workflow_dispatch: {} }
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions: { id-token: write, contents: read }
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
          aws-region: ap-southeast-1
      - name: Deploy endpoint
        env:
          REGION: ap-southeast-1
          MODEL_NAME: aqi-xgb-${{ github.run_id }}
          MODEL_DATA_URL: ${{ secrets.MODEL_TAR_S3 }}
          IMAGE_URI: 811284229777.dkr.ecr.ap-southeast-1.amazonaws.com/xgboost:1
          EXEC_ROLE_ARN: ${{ secrets.SM_EXEC_ROLE }}
          ENDPOINT_NAME: aqi-xgb-endpoint
        run: bash deploy/scripts/deploy_endpoint.sh
      - name: Smoke test
        env:
          ENDPOINT_NAME: aqi-xgb-endpoint
        run: python3 deploy/scripts/invoke_smoke.py
